import { Box, Button, Divider, Flex, Input, KeyboardAvoidingView, Text, Toast, useToast, View } from 'native-base';
import { WebView } from 'react-native-webview';
import { ActivityIndicator, Modal } from 'react-native';
import React from 'react';
import NHCSafeAreaView from '../../components/NHCSafeAreaView';
import TopBar from '../../components/Layout/TopBar';
import { Keyboard, ScrollView, TouchableOpacity, TouchableWithoutFeedback } from 'react-native';
import { useStore } from '../../hooks/useStore';
import { AntDesign } from '@expo/vector-icons';
import { numberWithCommas } from '../../ultils/common';
import { postDataAPI } from '../../api/FetchApi';
import axios from 'axios';

const initialState = {
    address: '',
    phone: '',
};

const OrderScreen = ({ navigation: { navigate } }) => {
    const toast = useToast();

    const [userr, setUserr] = useStore().userAPI.userr;
    const [shipping, setShipping] = React.useState('1');
    const [typePayment, setTypePayment] = React.useState('1');
    const [cart, setCart] = useStore().userAPI.cart;
    const addCart = useStore().userAPI.addCart;

    const [callback, setCallback] = useStore().callback;

    const [token, setToken] = useStore().token;
    const [loading, setLoading] = React.useState(false);

    const total = cart.reduce((tt: any, item: any) => {
        return tt + item.price * item.quantity;
    }, 0);
    const [openCheckoutPaypal, setOpenCheckoutPaypal] = React.useState(false);

    const [infoCustomer, setInfoCustomer] = React.useState(initialState);

    const handleCheckout = async () => {
        if (!infoCustomer.address || !infoCustomer.phone) {
            alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
            return;
        }
        if (typePayment === '1') {
            setOpenCheckoutPaypal(true);
        } else {
            setLoading(true);
            const res = await axios.post(
                'https://nongsan-app.herokuapp.com/api/payment',
                {
                    user: userr._id,
                    cart,
                    name: userr.username,
                    address: infoCustomer.address,
                    phone: infoCustomer.phone,
                    priceCheckout: total,
                },
                {
                    headers: { Authorization: token.token },
                }
            );
            if (res.status === 200) {
                const res2 = await axios.patch(
                    'https://nongsan-app.herokuapp.com/api/addcart',
                    { cart: [] },
                    {
                        headers: { Authorization: token.token },
                    }
                );
                setCart([]);
                if (res2.status === 200) {
                    const res3 = await axios.post('https://nongsan-app.herokuapp.com/api/noti', {
                        title: `${userr.username} ƒë√£ ƒë·∫∑t h√†ng th√†nh c√¥ng!`,
                        user: userr._id,
                    });
                    if (res3.status === 200) {
                        toast.show({
                            title: 'ƒê·∫∑t h√†ng th√†nh c√¥ng',
                            status: 'success',
                            description: 'C·∫£m ∆°n b·∫°n ƒë√£ s·ª≠ d·ª•ng d·ªãch v·ª•',
                            placement: 'top',
                        });
                        setCallback(!callback);
                        navigate('TabOne');
                        setLoading(false);
                    }
                }
            }
        }
    };
    let i = 0;
    const handleResponse = async (data: any) => {
        if (data.title === 'success' && !data.loading) {
            if (i == 0) {
                i++;

                try {
                    const res = await axios.post(
                        'https://nongsan-app.herokuapp.com/api/payment',
                        {
                            user: userr._id,
                            name: userr.username,
                            phone: infoCustomer.phone,
                            // email: userr.email,
                            address: infoCustomer.address,
                            cart: cart,
                            priceCheckout: total,
                            type: 'payment',
                        },
                        {
                            headers: { Authorization: token.token },
                        }
                    );
                    if (res.status == 200) {
                        toast.show({
                            title: 'Thanh to√°n v√† ƒë·∫∑t h√†ng th√†nh c√¥ng',
                            status: 'success',
                            description: 'C·∫£m ∆°n b·∫°n ƒë√£ s·ª≠ d·ª•ng d·ªãch v·ª•',
                            placement: 'top',
                        });
                        const res2 = await axios.patch(
                            'https://nongsan-app.herokuapp.com/api/addcart',
                            { cart: [] },
                            {
                                headers: { Authorization: token.token },
                            }
                        );
                        setCart([]);
                        if (res2.status === 200) {
                            const res3 = await axios.post('https://nongsan-app.herokuapp.com/api/noti', {
                                title: `${userr.username} ƒë√£ ƒë·∫∑t h√†ng th√†nh c√¥ng!`,
                                user: userr._id,
                            });
                            if (res3.status === 200) {
                                setCallback(!callback);
                                navigate('TabOne');
                            }
                        }
                    } else {
                        alert('C√≥ l·ªói x·∫£y ra');
                    }
                    setOpenCheckoutPaypal(false);
                } catch (error: any) {
                    console.log('üöÄ ~ file: OrderScreen.tsx ~ line 77 ~ handleResponse ~ error', error.response);
                    alert('C√≥ l·ªói x·∫£y ra');
                }
            } else {
                return;
            }
        } else if (data.title === 'cancel') {
            setOpenCheckoutPaypal(false);
        } else {
            return;
        }
    };

    return (
        <TouchableWithoutFeedback onPress={Keyboard.dismiss} accessible={false}>
            <KeyboardAvoidingView style={{ flex: 1, backgroundColor: 'white' }}>
                <View style={{ flex: 1, backgroundColor: 'white' }} px="6">
                    <TopBar title="THANH TO√ÅN" isBack />
                    {loading ? (
                        <ActivityIndicator size="large" color="blue" style={{ marginLeft: 8 }} />
                    ) : (
                        <>
                            <ScrollView showsVerticalScrollIndicator={false}>
                                <Text fontSize="lg" fontWeight="bold">
                                    Th√¥ng tin kh√°ch h√†ng
                                </Text>
                                <Divider bg="#000" mt="1" />
                                <Input variant="underlined" fontSize="16" value={userr.username} editable={false} />
                                <Input variant="underlined" fontSize="16" value={userr.email} editable={false} />
                                <Input
                                    value={infoCustomer.address}
                                    variant="underlined"
                                    fontSize="16"
                                    placeholder="ƒê·ªãa ch·ªâ"
                                    onChangeText={(text) => setInfoCustomer({ ...infoCustomer, address: text })}
                                />
                                <Input
                                    value={infoCustomer.phone}
                                    variant="underlined"
                                    fontSize="16"
                                    placeholder="S·ªë ƒëi·ªán tho·∫°i"
                                    keyboardType="numeric"
                                    onChangeText={(text) => setInfoCustomer({ ...infoCustomer, phone: text })}
                                />
                                <Text mt="5" fontSize="lg" fontWeight="bold">
                                    Ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn
                                </Text>
                                <Divider bg="#000" h=".5" mt="1" mb="4" />
                                <TouchableOpacity onPress={() => setShipping('1')}>
                                    <Flex flexDirection="row" alignItems="center" justifyContent="space-between">
                                        <View>
                                            <Text
                                                fontSize="md"
                                                fontWeight="500"
                                                color={shipping === '1' ? '#059669' : 'black'}
                                            >
                                                Giao h√†ng nhanh - 15.000ƒë
                                            </Text>
                                            <Text fontSize="sm" color="#888">
                                                D·ª± ki·∫øn giao h√†ng 3-5 ng√†y
                                            </Text>
                                        </View>
                                        <AntDesign
                                            name="check"
                                            size={24}
                                            color={shipping === '1' ? '#059669' : 'black'}
                                        />
                                    </Flex>
                                    <Divider bg="#aaa" h=".5" mt="1" mb="4" />
                                </TouchableOpacity>
                                <TouchableOpacity onPress={() => setShipping('2')}>
                                    <Flex flexDirection="row" alignItems="center" justifyContent="space-between">
                                        <View>
                                            <Text
                                                fontSize="md"
                                                fontWeight="500"
                                                color={shipping === '2' ? '#059669' : 'black'}
                                            >
                                                Giao h√†ng COD - 20.000ƒë
                                            </Text>
                                            <Text fontSize="sm" color="#888">
                                                D·ª± ki·∫øn giao h√†ng 2-4 ng√†y
                                            </Text>
                                        </View>
                                        <AntDesign
                                            name="check"
                                            size={24}
                                            color={shipping === '2' ? '#059669' : 'black'}
                                        />
                                    </Flex>
                                    <Divider bg="#aaa" h=".5" mt="1.5" mb="2" />
                                </TouchableOpacity>
                                <Text mt="3" fontSize="lg" fontWeight="bold">
                                    H√¨nh th·ª©c thanh to√°n
                                </Text>
                                <Divider bg="#000" h=".5" mt="1" mb="2" />
                                <TouchableOpacity onPress={() => setTypePayment('1')}>
                                    <Flex flexDirection="row" alignItems="center" justifyContent="space-between">
                                        <View>
                                            <Text
                                                fontSize="md"
                                                fontWeight="500"
                                                color={typePayment === '1' ? '#059669' : 'black'}
                                            >
                                                Paypal
                                            </Text>
                                        </View>
                                        <AntDesign
                                            name="check"
                                            size={24}
                                            color={typePayment === '1' ? '#059669' : 'black'}
                                        />
                                    </Flex>
                                    <Divider bg="#aaa" h=".5" mt="1.5" mb="2" />
                                </TouchableOpacity>
                                <TouchableOpacity onPress={() => setTypePayment('2')}>
                                    <Flex flexDirection="row" alignItems="center" mt="2" justifyContent="space-between">
                                        <View>
                                            <Text
                                                fontSize="md"
                                                fontWeight="500"
                                                color={typePayment === '2' ? '#059669' : 'black'}
                                            >
                                                Thanh to√°n khi nh·∫≠n h√†ng
                                            </Text>
                                        </View>
                                        <AntDesign
                                            name="check"
                                            size={24}
                                            color={typePayment === '2' ? '#059669' : 'black'}
                                        />
                                    </Flex>
                                    <Divider bg="#aaa" h=".5" mt="1.5" mb="2" />
                                </TouchableOpacity>
                            </ScrollView>
                            <View pt="4">
                                <Flex flexDirection="row" alignItems="center" justifyContent="space-between">
                                    <Text fontSize="sm" color="#888">
                                        T·∫°m t√≠nh
                                    </Text>
                                    <Text fontSize="md">{numberWithCommas(total)}ƒë</Text>
                                </Flex>
                                <Flex flexDirection="row" my="1" alignItems="center" justifyContent="space-between">
                                    <Text fontSize="sm" color="#888">
                                        Ph√≠ v·∫≠n chuy·ªÉn
                                    </Text>
                                    <Text fontSize="md">{shipping === '1' ? '15.000ƒë' : '20.000ƒë'}</Text>
                                </Flex>
                                <Flex flexDirection="row" alignItems="center" justifyContent="space-between">
                                    <Text fontSize="lg" color="#888">
                                        T·ªïng c·ªông
                                    </Text>
                                    <Text fontSize="lg" fontWeight="bold" color="#059669">
                                        {numberWithCommas(total + (shipping === '1' ? 15000 : 20000))}ƒë
                                    </Text>
                                </Flex>
                                <TouchableOpacity>
                                    <Button
                                        mb="3"
                                        h="12"
                                        size="lg"
                                        p="2"
                                        bg="tertiary.700"
                                        mt="3"
                                        onPress={handleCheckout}
                                        // disabled={count === 0}
                                    >
                                        TI·∫æP T·ª§C
                                    </Button>
                                </TouchableOpacity>
                            </View>
                            <Modal
                                visible={openCheckoutPaypal}
                                onRequestClose={() => setOpenCheckoutPaypal(!openCheckoutPaypal)}
                            >
                                <WebView
                                    source={{ uri: 'https://nongsan-app.herokuapp.com' }}
                                    onNavigationStateChange={(data) => handleResponse(data)}
                                    injectedJavaScript={`setTimeout(function() {document.getElementById("price").value=${total};document.f1.submit()}, 100);`}
                                />
                            </Modal>
                        </>
                    )}
                </View>
            </KeyboardAvoidingView>
        </TouchableWithoutFeedback>
    );
};

export default OrderScreen;
